<script lang="ts">
  import { Label } from "$lib/components/ui/label";
  import { Textarea } from "$lib/components/ui/textarea";
  import * as Select from "$lib/components/ui/select";
  import { Badge } from "$lib/components/ui/badge";
  import {
    Calendar,
    DollarSign,
    HandCoins,
    Tag,
    FileText,
    CheckCircle2,
    Info
  } from "@lucide/svelte/icons";
  import WizardStep from "./wizard-step.svelte";
  import DateInput from "$lib/components/input/date-input.svelte";
  import IntelligentNumericInput from "$lib/components/input/intelligent-numeric-input.svelte";
  import IntelligentEntityInput from "$lib/components/input/intelligent-entity-input.svelte";
  import { type DateValue, today, getLocalTimeZone } from "@internationalized/date";
  import { transactionWizardStore, type WizardStep as WizardStepType } from "$lib/stores/wizardStore.svelte";
  import { createTransactionValidationEngine } from "$lib/utils/wizardValidation";
  import type { Transaction } from "$lib/schema";
  import type { EditableEntityItem } from "$lib/types";
  import type { Component } from "svelte";
  import SquareMousePointer from '@lucide/svelte/icons/square-mouse-pointer';
  import { usePayeeIntelligence } from '$lib/hooks/use-payee-intelligence.svelte';
  import type {Payee} from '$lib/schema/payees';

  interface Props {
    accountId: number;
    initialData?: Partial<Transaction>;
    payees?: EditableEntityItem[];
    categories?: EditableEntityItem[];
    onComplete?: (data: Record<string, any>) => Promise<void>;
  }

  let { accountId, initialData = {}, payees = [], categories = [], onComplete }: Props = $props();

  // Initialize wizard steps
  const steps: WizardStepType[] = [
    {
      id: 'date-amount',
      title: 'Date & Amount',
      description: 'When did this transaction occur and for how much?'
    },
    {
      id: 'payee-category',
      title: 'Payee & Category',
      description: 'Who was involved and what category does this belong to?'
    },
    {
      id: 'notes-status',
      title: 'Notes & Status',
      description: 'Add any additional details (optional)',
      isOptional: true
    },
    {
      id: 'review',
      title: 'Review',
      description: 'Review your transaction details before saving'
    }
  ];

  const formData = $derived(transactionWizardStore.formData);

  // Form state
  let dateValue: DateValue = $state(today(getLocalTimeZone()));
  let amount = $state<number>(0);
  let payee = $state<EditableEntityItem>({
    id: 0,
    name: '',
  });
  let category = $state<EditableEntityItem>({
    id: 0,
    name: '',
  });
  let notes = $state<string>('');
  let status = $state<'cleared' | 'pending' | 'scheduled'>('pending');

  // Payee intelligence integration
  const { getPayeeSuggestionsFor, generateBasicSuggestions } = usePayeeIntelligence();

  // Get selected payee data for intelligence
  const selectedPayee = $derived.by(() => {
    if (!payee.id || payee.id === 0) return null;
    return (payees as Payee[]).find(p => p.id === payee.id) || null;
  });

  // Get intelligence query for selected payee
  const intelligenceQuery = $derived.by(() => {
    const currentPayee = selectedPayee;
    if (!currentPayee?.id || currentPayee.id === 0) return null;

    return getPayeeSuggestionsFor(
      currentPayee.id,
      categories as EditableEntityItem[],
      {
        transactionAmount: amount > 0 ? amount : 0,
        transactionDate: dateValue.toString(),
      }
    );
  });

  // Intelligence suggestions based on selected payee
  const intelligenceSuggestions = $derived.by(() => {
    const currentPayee = selectedPayee;
    if (!currentPayee) return null;

    // Try to get advanced intelligence first
    const query = intelligenceQuery;
    if (query) {
      try {
        const result = query.execute ? query.execute() : null;
        if (result) {
          const processed = query.processSuggestions(result, result);
          if (processed) return processed;
        }
      } catch (error) {
        console.warn('Intelligence query failed:', error);
      }
    }

    // Fallback to basic suggestions from payee data
    return generateBasicSuggestions(currentPayee, categories as EditableEntityItem[]);
  });

  // Category suggestion for EntityInput
  const categorySuggestion = $derived.by(() => {
    const suggestions = intelligenceSuggestions;
    if (!suggestions?.category?.suggestedCategory) return undefined;

    return {
      type: suggestions.category.type,
      reason: suggestions.category.reason,
      ...(suggestions.category.confidence !== undefined && { confidence: suggestions.category.confidence }),
      suggestedValue: suggestions.category.suggestedCategory,
      onApply: () => {
        if (suggestions.category?.suggestedCategory) {
          category = suggestions.category.suggestedCategory;
        }
      }
    } as const;
  });

  // Amount suggestion for NumericInput
  const amountSuggestion = $derived.by(() => {
    const suggestions = intelligenceSuggestions;
    if (!suggestions?.amount) return undefined;

    return {
      type: suggestions.amount.type,
      reason: suggestions.amount.reason,
      ...(suggestions.amount.confidence !== undefined && { confidence: suggestions.amount.confidence }),
      suggestedAmount: suggestions.amount.suggestedAmount || 0,
      onApply: () => {
        if (suggestions.amount?.suggestedAmount) {
          amount = suggestions.amount.suggestedAmount;
        }
      }
    } as const;
  });

  // Auto-apply suggestions when payee changes
  $effect(() => {
    const suggestions = intelligenceSuggestions;
    if (suggestions && payee.id > 0) {
      const shouldApplyCategory = !category.id || category.id === 0;
      const shouldApplyAmount = !amount || amount === 0;

      if (shouldApplyCategory && suggestions.category?.suggestedCategory) {
        category = suggestions.category.suggestedCategory;
      }

      if (shouldApplyAmount && suggestions.amount?.suggestedAmount) {
        amount = suggestions.amount.suggestedAmount;
      }
    }
  });

  // Set up validation engine
  const validationEngine = createTransactionValidationEngine();

  // Override the wizard store's validation method
  transactionWizardStore.validateStep = (stepId: string, formData: Record<string, any>) => {
    const result = validationEngine.validateStep(stepId, formData);
    transactionWizardStore.setStepValidation(stepId, result.isValid, result.errors);
    return result.isValid;
  };

  // Initialize the wizard once
  let initialized = $state(false);
  $effect(() => {
    if (!initialized) {
      const initData = {
        ...initialData,
        accountId,
        date: dateValue.toString(),
        amount,
        payeeId: payee.id,
        categoryId: category.id,
        notes,
        status
      };
      transactionWizardStore.initialize(steps, initData);
      initialized = true;
    }
  });

  // Update formData when state changes (without triggering validation on every keystroke)
  $effect(() => {
    if (initialized) {
      // Update formData directly without triggering validation
      // Validation will happen when user tries to navigate to next step
      Object.assign(transactionWizardStore.formData, {
        accountId,
        date: dateValue.toString(),
        amount,
        payeeId: payee.id,
        categoryId: category.id,
        notes,
        status
      });
    }
  });

  // Status options
  const statusOptions = [
    { value: 'pending', label: 'Pending', description: 'Transaction is pending' },
    { value: 'cleared', label: 'Cleared', description: 'Transaction has cleared' }
  ];

  // Review data formatting
  const reviewData = $derived.by(() => {
    const selectedPayeeName = payees.find(p => p.id === formData['payeeId'])?.name || 'Not selected';
    const selectedCategoryName = categories.find(c => c.id === formData['categoryId'])?.name || 'Not selected';
    const statusLabel = statusOptions.find(s => s.value === formData['status'])?.label || 'Pending';

    return {
      date: formData['date'] || 'Not set',
      amount: formData['amount'] || 0,
      payee: selectedPayeeName,
      category: selectedCategoryName,
      status: statusLabel,
      notes: formData['notes'] || 'No notes added'
    };
  });

  // Handle completion
  async function handleComplete() {
    if (onComplete) {
      transactionWizardStore.startCompleting();
      try {
        await onComplete(formData);
        transactionWizardStore.reset();
      } catch (error) {
        console.error('Failed to complete transaction:', error);
      } finally {
        transactionWizardStore.stopCompleting();
      }
    }
  }
</script>

<!-- Step 1: Date & Amount -->
<WizardStep
  wizardStore={transactionWizardStore}
  stepId="date-amount"
  title="Date & Amount"
  description="When did this transaction occur and for how much?"
>
  <div class="space-y-6">
    <!-- Date Input -->
    <div class="space-y-2">
      <Label for="transaction-date" class="text-sm font-medium">
        Transaction Date *
      </Label>
      <DateInput bind:value={dateValue} />
      <p class="text-xs text-muted-foreground">
        Select the date when this transaction occurred.
      </p>
    </div>

    <!-- Amount Input -->
    <div class="space-y-2">
      <Label for="amount" class="text-sm font-medium">
        Amount *
      </Label>
      <IntelligentNumericInput
        bind:value={amount}
        buttonClass="w-full"
        {...(amountSuggestion && { suggestion: amountSuggestion })}
      />
      <p class="text-xs text-muted-foreground">
        Enter a negative amount for expenses, positive for income.
      </p>
    </div>
  </div>
</WizardStep>

<!-- Step 2: Payee & Category -->
<WizardStep
  wizardStore={transactionWizardStore}
  stepId="payee-category"
  title="Payee & Category"
  description="Who was involved and what category does this belong to?"
>
  <div class="space-y-6">
    <!-- Payee Selection -->
    <div class="space-y-2">
      <Label class="text-sm font-medium">Payee</Label>
      <IntelligentEntityInput
        entityLabel="payees"
        entities={payees}
        bind:value={payee}
        icon={HandCoins as unknown as Component}
        buttonClass="w-full"
      />
      <p class="text-xs text-muted-foreground">
        Select the person or organization involved in this transaction.
      </p>
    </div>

    <!-- Category Selection -->
    <div class="space-y-2">
      <Label class="text-sm font-medium">Category</Label>
      <IntelligentEntityInput
        entityLabel="categories"
        entities={categories}
        bind:value={category}
        icon={SquareMousePointer as unknown as Component}
        buttonClass="w-full"
        {...(categorySuggestion && { suggestion: categorySuggestion })}
      />
      <p class="text-xs text-muted-foreground">
        Choose the category that best describes this transaction.
      </p>
    </div>
  </div>
</WizardStep>

<!-- Step 3: Notes & Status (Optional) -->
<WizardStep
  wizardStore={transactionWizardStore}
  stepId="notes-status"
  title="Notes & Status"
  description="Add any additional details (optional)"
>
  <div class="space-y-6">
    <!-- Status Selection -->
    <div class="space-y-2">
      <Label class="text-sm font-medium">Transaction Status</Label>
      <Select.Root
        type="single"
        value={status}
        onValueChange={(value) => value && (status = value as 'cleared' | 'pending' | 'scheduled')}
      >
        <Select.Trigger>
          {statusOptions.find(s => s.value === status)?.label || 'Select status'}
        </Select.Trigger>
        <Select.Content>
          {#each statusOptions as statusOption}
            <Select.Item value={statusOption.value}>
              <div class="flex flex-col">
                <span>{statusOption.label}</span>
                <span class="text-xs text-muted-foreground">{statusOption.description}</span>
              </div>
            </Select.Item>
          {/each}
        </Select.Content>
      </Select.Root>
    </div>

    <!-- Notes -->
    <div class="space-y-2">
      <Label for="notes" class="text-sm font-medium">Notes</Label>
      <Textarea
        id="notes"
        bind:value={notes}
        placeholder="Add any notes about this transaction..."
        rows={4}
      />
      <p class="text-xs text-muted-foreground">
        Optional notes to help you remember details about this transaction.
      </p>
    </div>
  </div>
</WizardStep>

<!-- Step 4: Review -->
<WizardStep
  wizardStore={transactionWizardStore}
  stepId="review"
  title="Review Transaction"
  description="Review your transaction details before saving"
  onNext={handleComplete}
>
  <div class="space-y-6">
    <!-- Transaction Summary -->
    <div class="rounded-lg border bg-card p-6 space-y-4">
      <div class="flex items-start justify-between">
        <div class="space-y-1">
          <p class="text-sm font-medium text-muted-foreground">Amount</p>
          <p class="text-2xl font-bold">
            ${Math.abs(reviewData.amount).toFixed(2)}
            {#if reviewData.amount < 0}
              <Badge variant="destructive" class="ml-2">Expense</Badge>
            {:else}
              <Badge variant="default" class="ml-2">Income</Badge>
            {/if}
          </p>
        </div>
        <Calendar class="h-8 w-8 text-muted-foreground" />
      </div>

      <div class="grid grid-cols-2 gap-4 pt-4 border-t">
        <div class="space-y-1">
          <p class="text-xs font-medium text-muted-foreground">Date</p>
          <p class="text-sm">{reviewData.date}</p>
        </div>
        <div class="space-y-1">
          <p class="text-xs font-medium text-muted-foreground">Status</p>
          <p class="text-sm">{reviewData.status}</p>
        </div>
        <div class="space-y-1">
          <p class="text-xs font-medium text-muted-foreground">Payee</p>
          <p class="text-sm">{reviewData.payee}</p>
        </div>
        <div class="space-y-1">
          <p class="text-xs font-medium text-muted-foreground">Category</p>
          <p class="text-sm">{reviewData.category}</p>
        </div>
      </div>

      {#if reviewData.notes && reviewData.notes !== 'No notes added'}
        <div class="space-y-1 pt-4 border-t">
          <p class="text-xs font-medium text-muted-foreground">Notes</p>
          <p class="text-sm">{reviewData.notes}</p>
        </div>
      {/if}
    </div>

    <!-- Help Text -->
    <div class="flex items-start gap-3 rounded-lg bg-muted/50 p-4">
      <Info class="h-5 w-5 text-muted-foreground mt-0.5" />
      <div class="space-y-1">
        <p class="text-sm font-medium">Ready to save?</p>
        <p class="text-xs text-muted-foreground">
          Click "Complete" to save this transaction. You can edit it later if needed.
        </p>
      </div>
    </div>
  </div>
</WizardStep>
